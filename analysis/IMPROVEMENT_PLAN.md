
# Google Sheetsテンプレート改善計画

## 文書情報
- **作成日**: 2025年11月15日
- **対象**: 納品書・請求書テンプレート
- **目的**: PDFデザインに合わせたテンプレートの改善
- **関連文書**:
  - `ANALYSIS.md`（現状分析）
  - `DATA_MAPPING.md`（データマッピング）

---

## エグゼクティブサマリー

### 現状
既存のGoogle Sheetsテンプレートは4列の非常にシンプルな構成で、PDFサンプルデザイン（9列構成）とは大きく異なります。

### 問題点
1. **構造の不一致**: 4列 vs 9列（+5列不足）
2. **デザインの不一致**: 白背景 vs 青背景
3. **機能不足**: 税率別集計、振込先情報がない
4. **数式なし**: APIが全ての値を直接書き込み

### 推奨アプローチ
**新規テンプレートの作成** + 段階的移行

既存テンプレートを無理に改修するよりも、PDFデザインに基づいた新しいテンプレートを作成し、システムを段階的に移行する方が効率的でリスクが低い。

---

## Phase別実装計画

### Phase 1: 新テンプレートの作成とデザイン実装

**目的**: PDFデザインに完全に一致する新しいテンプレートを作成

**作業内容**:

#### 1-1. 新しいスプレッドシートの作成
- [ ] Google Driveで新規スプレッドシート作成
  - 名前: 「ボニカ請求書テンプレートv2」
  - 権限: サービスアカウントに編集権限を付与

- [ ] シート名を設定
  - シート1: 「請求書テンプレート」

#### 1-2. ヘッダー部分の実装

**タイトル行（1行目）**:
- [ ] A1:I1をセル結合
- [ ] 背景色を#00A0E9に設定
- [ ] 文字色を白に設定
- [ ] テキスト「請求書」を入力
- [ ] フォント: Arial または Meiryo、16pt、太字
- [ ] 配置: 左寄せ（左パディング10px程度）

**顧客情報（2-3行目、左側）**:
- [ ] A3: 「顧客名:」（ラベル）
- [ ] B3:D3結合: プレースホルダー「{{customer_name}}」
- [ ] フォント: 14pt

**請求情報（2-3行目、右側）**:
- [ ] G2: 「請求No.{{invoice_number}}」
- [ ] G3: 「{{invoice_date}}」（YYYY/MM形式）

**会社情報（2-7行目、最右側）**:
- [ ] H2: 法人番号「T9030001039654」
- [ ] H3: 「株式会社 ボニカ・アグリジェント」
- [ ] H4: 「〒341-0035」
- [ ] H5: 「埼玉県三郷市鷹野4-441」
- [ ] H6: 「TEL 048-954-6891」
- [ ] H7: 「FAX 048-954-6892」
- [ ] フォント: 10pt
- [ ] 配置: 右寄せ

**請求金額表示（5行目）**:
- [ ] A5: 「今回ご請求額」
- [ ] B5:D5結合: プレースホルダー「{{total_amount}}」
- [ ] フォント: 18pt、太字
- [ ] 背景色: 薄い黄色（#FFFFCC）

#### 1-3. 明細テーブルの実装

**ヘッダー行（11行目）**:
- [ ] A11〜I11: 各列に項目名を入力
  - A11: 日付
  - B11: 品名
  - C11: 単価
  - D11: 数量
  - E11: 単位
  - F11: 税率
  - G11: 税抜金額
  - H11: 消費税
  - I11: 備考

- [ ] 書式設定
  - 背景色: #00A0E9 または #808080（濃いグレー）
  - 文字色: 白
  - フォント: 太字
  - 配置: 中央揃え
  - 罫線: 上下に太線（2pt）

**データ行のテンプレート（12行目）**:
- [ ] A12: プレースホルダー「{{date}}」
- [ ] B12: プレースホルダー「{{product_name}}」
- [ ] C12: プレースホルダー「{{unit_price}}」
- [ ] D12: プレースホルダー「{{quantity}}」
- [ ] E12: プレースホルダー「{{unit}}」
- [ ] F12: プレースホルダー「{{tax_rate}}」
- [ ] G12: **数式**: `=IF(AND(C12<>"", D12<>""), C12*D12, "")`
- [ ] H12: **数式**: `=IF(AND(G12<>"", F12<>""), G12*VALUE(SUBSTITUTE(F12,"%",""))/100, "")`
- [ ] I12: プレースホルダー「{{remarks}}」

- [ ] 書式設定
  - 罫線: 全辺に細線（1pt）
  - 数値書式: C, D, G, H列は通貨（カンマ区切り）

- [ ] 12行目をコピーして13〜59行目にペースト
  - 数式が自動で調整されることを確認

#### 1-4. フッター部分の実装

**振込先情報ブロック（60-65行目、左側）**:
- [ ] A60: 「お振込先」（太字）
- [ ] A61: 「金融機関: 朝日信用金庫」
- [ ] A62: 「支店名: 三郷支店」
- [ ] A63: 「口座種別: 普通」
- [ ] A64: 「口座番号: 0430910」
- [ ] A65: 「口座名義: カ)ボニカ・アグリジェント」
- [ ] 書式設定
  - 罫線: テーブル形式
  - フォント: 10pt

**税額集計ブロック（60-65行目、右側）**:
- [ ] F60: 「10%対象額」
- [ ] G60: **数式**: `=SUMIF(F$12:F$59,"10%",G$12:G$59)`
- [ ] F61: 「10%消費税額」
- [ ] G61: **数式**: `=SUMIF(F$12:F$59,"10%",H$12:H$59)`
- [ ] F62: 「8%対象額」
- [ ] G62: **数式**: `=SUMIF(F$12:F$59,"8%",G$12:G$59)`
- [ ] F63: 「8%消費税額」
- [ ] G63: **数式**: `=SUMIF(F$12:F$59,"8%",H$12:H$59)`
- [ ] F64: 「合計金額」（太字）
- [ ] G64: **数式**: `=SUM(G$12:G$59)+SUM(H$12:H$59)`
- [ ] F65: 「合計税額」
- [ ] G65: **数式**: `=SUM(H$12:H$59)`
- [ ] 書式設定
  - 罫線: テーブル形式、60行目上と65行目下は太線
  - 数値書式: 通貨（カンマ区切り）
  - 64行目は背景色を薄い黄色に

**請求金額表示の数式リンク**:
- [ ] B5の数式を変更: `=G64`（集計値と連動）

#### 1-5. 列幅の調整
- [ ] A列: 80px（日付）
- [ ] B列: 250px（品名）
- [ ] C列: 80px（単価）
- [ ] D列: 60px（数量）
- [ ] E列: 50px（単位）
- [ ] F列: 50px（税率）
- [ ] G列: 100px（税抜金額）
- [ ] H列: 80px（消費税）
- [ ] I列: 150px（備考）

#### 1-6. 印刷設定
- [ ] 用紙サイズ: A4
- [ ] 印刷方向: 縦
- [ ] 余白: 上下左右 1.5cm
- [ ] 拡大縮小: 100%
- [ ] ページ区切り: なし（1ページに収める）

#### Phase 1の成果物
- ✅ 新しいスプレッドシートID
- ✅ 視覚的にPDFと一致するテンプレート
- ✅ 数式が正しく動作することの確認

#### Phase 1のリスク評価
- **システム連携への影響**: **なし**（まだ接続していない）
- **既存データとの互換性**: **影響なし**（新規作成）
- **作業時間**: 2-3時間

---

### Phase 2: システム連携の実装

**目的**: 新テンプレートにデータを投入できるようにする

**作業内容**:

#### 2-1. 環境変数の追加
- [ ] `.env.local`に新しいスプレッドシートIDを追加
  ```env
  GOOGLE_SHEETS_INVOICE_TEMPLATE_V2_SHEET_ID="[新しいスプレッドシートID]"
  ```

- [ ] 本番環境（Vercel）にも同じ環境変数を追加

#### 2-2. TypeScript型定義の更新

**ファイル**: `lib/google-sheets-client.ts`

- [ ] `DeliveryData`インターフェースを更新
  ```typescript
  interface DeliveryData {
    delivery_number: string;
    delivery_date: string;
    customer_name: string;
    total_amount: number;
    items: {
      product_name: string;
      quantity: number;
      unit_price: number;
      unit: string;              // ★追加
      tax_rate: number;          // ★追加（8 or 10）
      delivery_date?: string;    // ★追加
      remarks?: string;          // ★追加
    }[];
    subtotal_8: number;          // ★追加
    tax_8: number;               // ★追加
    subtotal_10: number;         // ★追加
    tax_10: number;              // ★追加
    total_tax: number;           // ★追加
  }
  ```

#### 2-3. データ投入ロジックの実装

**ファイル**: `lib/google-sheets-client.ts`

**新しいメソッドを追加**: `createInvoiceV2`

```typescript
async createInvoiceV2(data: DeliveryData): Promise<{ sheetId: string; url: string }> {
  try {
    // 1. テンプレートをコピー
    const newSheetId = await this.copyTemplate(
      process.env.GOOGLE_SHEETS_INVOICE_TEMPLATE_V2_SHEET_ID!
    );

    // 2. ヘッダー部分のデータを投入
    const headerUpdates = [
      { range: 'B3', values: [[`${data.customer_name} 御中`]] },
      { range: 'G2', values: [[`請求No.${data.delivery_number}`]] },
      { range: 'G3', values: [[data.delivery_date]] }, // YYYY/MM形式
    ];

    await this.batchUpdate(newSheetId, headerUpdates);

    // 3. 明細データを投入
    const itemsStartRow = 12; // 12行目から
    const itemUpdates = [];

    data.items.forEach((item, index) => {
      const row = itemsStartRow + index;

      itemUpdates.push(
        { range: `A${row}`, values: [[item.delivery_date || '']] },
        { range: `B${row}`, values: [[item.product_name]] },
        { range: `C${row}`, values: [[item.unit_price]] },
        { range: `D${row}`, values: [[item.quantity]] },
        { range: `E${row}`, values: [[item.unit]] },
        { range: `F${row}`, values: [[`${item.tax_rate}%`]] },
        // G列とH列は数式なので投入しない
        { range: `I${row}`, values: [[item.remarks || '']] }
      );
    });

    await this.batchUpdate(newSheetId, itemUpdates);

    // 4. 数式を再計算（必要に応じて）
    // Google Sheetsは自動で再計算するため、通常は不要

    // 5. URLを生成
    const url = `https://docs.google.com/spreadsheets/d/${newSheetId}`;

    return { sheetId: newSheetId, url };

  } catch (error) {
    throw new GoogleSheetsError(
      '請求書の作成に失敗しました',
      error as Error,
      GoogleSheetsErrorCode.UNKNOWN_ERROR
    );
  }
}
```

#### 2-4. APIエンドポイントの実装

**ファイル**: `app/api/invoices/create-v2/route.ts`（新規作成）

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { GoogleSheetsClient } from '@/lib/google-sheets-client';

export async function POST(request: NextRequest) {
  try {
    const data = await request.json();

    // データの検証
    if (!data.delivery_number || !data.customer_name || !data.items) {
      return NextResponse.json(
        { error: '必須項目が不足しています' },
        { status: 400 }
      );
    }

    // Google Sheets クライアントの初期化
    const client = new GoogleSheetsClient({
      oauthClientId: process.env.GOOGLE_OAUTH_CLIENT_ID,
      oauthClientSecret: process.env.GOOGLE_OAUTH_CLIENT_SECRET,
      oauthRefreshToken: process.env.GOOGLE_OAUTH_REFRESH_TOKEN,
    });

    // 請求書を作成
    const result = await client.createInvoiceV2(data);

    return NextResponse.json({
      success: true,
      sheetId: result.sheetId,
      url: result.url,
    });

  } catch (error: any) {
    console.error('Invoice creation error:', error);
    return NextResponse.json(
      { error: error.message || '請求書の作成に失敗しました' },
      { status: 500 }
    );
  }
}
```

#### 2-5. フロントエンドの実装

**ファイル**: `app/deliveries/page.tsx`（既存ファイルを修正）

- [ ] 新しいAPIエンドポイントを呼び出すボタンを追加
  ```tsx
  <Button onClick={handleCreateInvoiceV2}>
    新形式で請求書を作成
  </Button>
  ```

- [ ] ハンドラー関数を実装
  ```typescript
  const handleCreateInvoiceV2 = async (deliveryId: string) => {
    try {
      const delivery = await fetchDeliveryData(deliveryId);
      const response = await fetch('/api/invoices/create-v2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(prepareDeliveryData(delivery)),
      });

      const result = await response.json();

      if (result.success) {
        alert(`請求書を作成しました: ${result.url}`);
        window.open(result.url, '_blank');
      } else {
        alert(`エラー: ${result.error}`);
      }
    } catch (error) {
      alert('請求書の作成に失敗しました');
    }
  };
  ```

#### Phase 2の成果物
- ✅ 新テンプレートにデータが正しく投入される
- ✅ 数式が正しく計算される
- ✅ 税額集計が正しく表示される
- ✅ フロントエンドから新形式の請求書を作成できる

#### Phase 2のリスク評価
- **システム連携への影響**: **中**（新しいコードの追加）
- **既存機能への影響**: **なし**（既存APIは変更しない）
- **データの検証**: 必須（テストケースを作成）
- **作業時間**: 3-4時間

---

### Phase 3: テストと検証

**目的**: 新システムが正しく動作することを確認

**作業内容**:

#### 3-1. 単体テストの作成
- [ ] `lib/google-sheets-client.ts`のテスト
  - データ投入の正確性
  - エラーハンドリング
  - 数式の動作確認

#### 3-2. 統合テストの実施
- [ ] テストデータで請求書を作成
  - PDFサンプルと同じデータを使用
  - 計算結果が一致することを確認

#### 3-3. 視覚的な確認
- [ ] 作成された請求書のスクリーンショットを撮影
- [ ] PDFサンプルと並べて比較
  - レイアウト
  - フォント
  - 色
  - 罫線
  - 計算結果

#### 3-4. エッジケースのテスト
- [ ] 明細が1件のみの場合
- [ ] 明細が50件（ほぼ満杯）の場合
- [ ] 8%のみの商品
- [ ] 10%のみの商品
- [ ] 0円の商品
- [ ] 小数点以下の数量

#### Phase 3の成果物
- ✅ テストレポート
- ✅ 不具合リスト（あれば）
- ✅ 改善提案

#### Phase 3のリスク評価
- **システム連携への影響**: **なし**（テストのみ）
- **作業時間**: 2-3時間

---

### Phase 4: 本番移行と既存システムの置き換え

**目的**: 新システムを本番稼働させる

**作業内容**:

#### 4-1. 段階的な移行計画

**オプション A: 並行運用**
- 既存システムと新システムを両方残す
- ユーザーがどちらを使うか選択できる
- 一定期間後、新システムのみに移行

**オプション B: 一斉移行**
- 既存システムを新システムに置き換え
- 古いAPIエンドポイントを新しいロジックに書き換え

**推奨**: **オプション A**（並行運用）
- リスクが低い
- 問題が発生しても既存システムに戻せる

#### 4-2. 既存APIの更新（オプション Aの場合は不要）

**ファイル**: `app/api/invoices/create/route.ts`

- [ ] 既存のロジックを新しいロジックに置き換え
- [ ] 古いテンプレートIDを新しいテンプレートIDに変更

#### 4-3. ユーザーへの通知
- [ ] リリースノートを作成
- [ ] 新しいデザインのスクリーンショットを共有
- [ ] 使い方ガイドを更新

#### 4-4. モニタリング
- [ ] 本番環境でのエラーログを監視
- [ ] ユーザーフィードバックを収集
- [ ] 計算結果の正確性を確認

#### Phase 4の成果物
- ✅ 本番稼働開始
- ✅ ユーザーガイド
- ✅ モニタリングレポート

#### Phase 4のリスク評価
- **システム連携への影響**: **高**（本番環境の変更）
- **既存データとの互換性**: 確認済み（Phase 3で検証）
- **ロールバック計画**: 必須
- **作業時間**: 1-2時間（作業） + 1週間（モニタリング）

---

## 推奨実装順序

### 最小リスクアプローチ

```
Phase 1（新テンプレート作成）
  ↓ 確認・承認
Phase 2（システム連携）
  ↓ 確認・テスト
Phase 3（検証）
  ↓ 結果レビュー
Phase 4（本番移行）
```

各Phaseの間に必ず確認ポイントを設けて、問題がないことを確認してから次に進む。

---

## 確認が必要な事項（システム担当者への質問）

実装前に以下を必ず確認してください：

### 1. データソースの確認
**質問**:
- 現在、納品データからどのように請求書を生成していますか？
- `unit`（単位）、`tax_rate`（税率）、`remarks`（備考）のデータはどこから取得できますか？

**回答待ち**: ________________________

### 2. 計算ロジックの確認
**質問**:
- 消費税の端数処理はどうしていますか？（四捨五入 / 切り捨て / 切り上げ）
- 現在のシステムで8%と10%の混在は対応していますか？

**回答待ち**: ________________________

### 3. 既存データとの互換性
**質問**:
- 過去に作成した請求書（既存テンプレート）は、今後も閲覧・編集する必要がありますか？
- 新旧のテンプレートを並行運用する期間はどのくらいを想定していますか？

**回答待ち**: ________________________

### 4. 環境変数の管理
**質問**:
- 環境変数`GOOGLE_SHEETS_DELIVERY_TEMPLATE_SHEET_ID`と`GOOGLE_SHEETS_INVOICE_TEMPLATE_SHEET_ID`が逆になっている可能性がありますが、確認できますか？

**回答待ち**: ________________________

### 5. デザインの優先順位
**質問**:
- PDFデザインとの完全一致と、システム互換性、どちらを優先しますか？
- 会社情報（法人番号、住所、電話番号）は固定値でよいですか、それともデータベースから取得しますか？

**回答待ち**: ________________________

### 6. テストデータの準備
**質問**:
- テスト用の納品データを提供していただけますか？
- PDFサンプルと同じデータがあれば、それを使ってテストしたいです。

**回答待ち**: ________________________

---

## 代替案の検討

### 代替案 A: 既存テンプレートを段階的に改修

**メリット**:
- スプレッドシートIDを変更しなくてよい
- 環境変数の変更が不要

**デメリット**:
- 既存の請求書が壊れるリスク
- システムコードの変更が複雑になる
- ロールバックが困難

**推奨度**: ❌ 非推奨

### 代替案 B: PDFデザインを既存テンプレートに合わせる

**メリット**:
- システムの変更が不要

**デメリット**:
- ビジュアルデザインが劣化する
- インボイス制度対応（法人番号表示）ができない
- 税率別集計ができない

**推奨度**: ❌ 非推奨

### 推奨案: 新テンプレート作成 + 段階的移行

**メリット**:
- リスクが最小
- いつでもロールバック可能
- 既存システムに影響しない
- PDFデザインを完全に再現できる

**デメリット**:
- 実装工数がやや多い（全体で10-12時間）
- 一時的に2つのシステムを管理する必要がある

**推奨度**: ✅ **強く推奨**

---

## スケジュール（推定）

### タイムライン（1人での作業を想定）

| Phase | 作業内容 | 所要時間 | 累積時間 |
|-------|---------|---------|---------|
| Phase 1 | 新テンプレート作成 | 2-3時間 | 2-3時間 |
| **確認** | レビュー・承認 | 1日 | - |
| Phase 2 | システム連携実装 | 3-4時間 | 5-7時間 |
| **確認** | コードレビュー | 1日 | - |
| Phase 3 | テスト・検証 | 2-3時間 | 7-10時間 |
| **確認** | 結果レビュー | 1日 | - |
| Phase 4 | 本番移行 | 1-2時間 | 8-12時間 |
| **監視** | モニタリング | 1週間 | - |

**総作業時間**: 8-12時間（実作業）
**総期間**: 1-2週間（確認期間を含む）

### マイルストーン

- **Week 1, Day 1-2**: Phase 1完了、確認依頼
- **Week 1, Day 3-4**: Phase 2完了、コードレビュー
- **Week 1, Day 5**: Phase 3完了、結果レビュー
- **Week 2, Day 1**: Phase 4実施（本番リリース）
- **Week 2, Day 2-5**: モニタリング期間
- **Week 2, Day 5**: プロジェクト完了

---

## 成功基準（Definition of Done）

### Phase 1の成功基準
- [ ] 新テンプレートがPDFと視覚的に一致している
- [ ] 全ての数式が正しく動作する
- [ ] 印刷時にA4用紙1ページに収まる

### Phase 2の成功基準
- [ ] APIからデータを投入できる
- [ ] 投入されたデータが正しく表示される
- [ ] 数式が自動で計算される
- [ ] エラーハンドリングが機能する

### Phase 3の成功基準
- [ ] 全てのテストケースが合格
- [ ] PDFサンプルと同じ計算結果になる
- [ ] エッジケースでもエラーが発生しない

### Phase 4の成功基準
- [ ] 本番環境でエラーが発生しない
- [ ] ユーザーが新形式で請求書を作成できる
- [ ] 計算結果が正確である

### プロジェクト全体の成功基準
- [ ] PDFデザインを完全に再現できている
- [ ] システムが安定稼働している
- [ ] ユーザーからの不具合報告がない
- [ ] 既存システムからの完全移行が完了している（または並行運用が安定している）

---

## リスク管理

### 技術的リスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| 数式が正しく動作しない | 低 | 中 | Phase 1で十分にテスト |
| データ投入時にエラー | 中 | 高 | エラーハンドリングを実装、ログを記録 |
| 計算結果が不正確 | 低 | 高 | Phase 3で厳密に検証 |
| 既存システムとの干渉 | 低 | 中 | 並行運用で影響を分離 |
| 環境変数の設定ミス | 中 | 高 | Phase 2開始前に確認 |

### ビジネスリスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| ユーザーが新デザインを嫌う | 低 | 低 | 事前にプレビューを共有 |
| 移行期間が長引く | 中 | 低 | 並行運用を許容 |
| 過去の請求書が見れなくなる | 低 | 高 | 既存テンプレートは削除しない |

---

## 次のアクション

### 即座に実行可能
1. **環境変数の確認**
   - `.env.local`の`GOOGLE_SHEETS_DELIVERY_TEMPLATE_SHEET_ID`と`GOOGLE_SHEETS_INVOICE_TEMPLATE_SHEET_ID`が正しいか確認
   - 必要に応じて修正

2. **質問事項の回答**
   - 「確認が必要な事項」セクションの質問に回答

3. **Phase 1の開始**
   - 新しいスプレッドシートを作成
   - テンプレートデザインを実装

### 承認が必要
- [ ] この改善計画全体の承認
- [ ] Phase 1完了後の確認・承認
- [ ] Phase 2完了後の確認・承認
- [ ] Phase 4（本番移行）の承認

---

## まとめ

### 推奨アプローチ
**新規テンプレート作成 + 段階的移行**

### 理由
1. リスクが最小
2. PDFデザインを完全に再現できる
3. いつでもロールバック可能
4. 既存システムに影響しない

### 期待される成果
- インボイス制度に完全対応（法人番号表示）
- 税率別集計（8%/10%）が自動計算
- プロフェッショナルな見た目の請求書
- ユーザー満足度の向上

### 次のステップ
1. ✅ この計画書のレビュー
2. ✅ 質問事項への回答
3. ✅ Phase 1の実施開始

**ご不明な点があれば、いつでもお尋ねください。**
