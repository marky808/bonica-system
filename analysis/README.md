# Google Sheetsテンプレート分析プロジェクト

## 📋 概要

このディレクトリには、BONICAシステムの納品書・請求書Google Sheetsテンプレートの詳細分析と改善計画が含まれています。

**分析日時**: 2025年11月15日

---

## 📁 ファイル一覧

### 1. **ANALYSIS.md** - 現状分析レポート
既存のGoogle Sheetsテンプレートとス PDFサンプルデザインの詳細な比較分析

**内容**:
- 既存テンプレートの構造分析（納品書・請求書）
- PDFサンプルデザインの詳細分析
- 両者の比較と差分の洗い出し
- 重大な発見（環境変数の設定ミスの可能性）
- 計算式の検証

**ページ数**: 約635行

### 2. **DATA_MAPPING.md** - データマッピング表
PDFデザインの項目と既存テンプレートの対応関係、データ投入に必要な全情報

**内容**:
- 明細テーブルの列ごとのマッピング
- ヘッダー・フッター部分のマッピング
- 数式の完全なリスト
- セルアドレスの完全なマッピング
- APIデータ構造との対応
- 列幅・罫線の推奨値

**ページ数**: 約300行

### 3. **IMPROVEMENT_PLAN.md** - 改善計画書
具体的な実装手順、リスク評価、スケジュール

**内容**:
- Phase 1〜4の詳細な実装計画
- 各Phaseのチェックリスト
- リスク評価とマイルストーン
- システム担当者への質問リスト
- 代替案の検討
- 成功基準（Definition of Done）

**ページ数**: 約550行

### 4. **TEMPLATE_STRUCTURE_REPORT.md** - テンプレート構造レポート
JSONデータから自動生成された、読みやすい形式のレポート

**内容**:
- 既存テンプレートのセル単位の詳細情報
- ヘッダー行の構成
- 明細テーブルの列構成
- セル結合の一覧

**ページ数**: 約160行

### 5. **分析用JSONファイル**
- `納品書テンプレート_analysis.json` - 納品書テンプレートの完全なデータ
- `請求書テンプレート_analysis.json` - 請求書テンプレートの完全なデータ

---

## 🔍 主要な発見

### 1. 環境変数の設定ミスの可能性

`.env.local`の設定が実際のスプレッドシートと逆になっている可能性があります：

```env
# 現在の設定
GOOGLE_SHEETS_DELIVERY_TEMPLATE_SHEET_ID="1vaxKYp767uQXg9E6EPDcL4QFwZoqLCpZ7AT32GMhrCY"
GOOGLE_SHEETS_INVOICE_TEMPLATE_SHEET_ID="1_zOTChDJsjrKFtNMAKezlFe0N4ZmEz9WV1Ypc4NsVxQ"

# しかし実際は
1_zOTChDJsjrKFtNMAKezlFe0N4ZmEz9WV1Ypc4NsVxQ → 「ボニカ請求書」
1vaxKYp767uQXg9E6EPDcL4QFwZoqLCpZ7AT32GMhrCY → 「ボニカ納品書」
```

### 2. テンプレートの構造が大きく異なる

| 項目 | 既存テンプレート | PDFデザイン | 差分 |
|------|-----------------|------------|------|
| 列数 | 4列 | 9列 | +5列 |
| タイトル背景色 | 白 | 青（#00A0E9） | 変更必要 |
| 税率別集計 | なし | あり | 追加必要 |
| 振込先情報 | なし | あり | 追加必要 |
| 数式 | なし | あり | 実装必要 |

### 3. 不足している項目

**明細テーブル**:
- 日付列
- 単位列
- 税率列
- 消費税列
- 備考列

**ヘッダー・フッター**:
- 法人番号（T番号）
- 会社住所・連絡先
- 振込先情報ブロック
- 税率別集計ブロック

---

## 💡 推奨アプローチ

### 新規テンプレート作成 + 段階的移行

**理由**:
1. ✅ リスクが最小
2. ✅ PDFデザインを完全に再現できる
3. ✅ いつでもロールバック可能
4. ✅ 既存システムに影響しない

**実装期間**: 1-2週間（実作業8-12時間 + 確認・モニタリング期間）

---

## 📊 実装のPhase

### Phase 1: 新テンプレートの作成（2-3時間）
- Google Sheetsで新しいスプレッドシートを作成
- PDFデザインに基づいてレイアウトを実装
- 数式を組み込む
- 視覚的な確認

### Phase 2: システム連携の実装（3-4時間）
- TypeScript型定義の更新
- データ投入ロジックの実装
- APIエンドポイントの作成
- フロントエンドの実装

### Phase 3: テストと検証（2-3時間）
- 単体テスト・統合テストの実施
- PDFサンプルとの比較
- エッジケースのテスト
- 不具合の修正

### Phase 4: 本番移行（1-2時間 + 1週間モニタリング）
- 環境変数の設定
- 本番環境へのデプロイ
- ユーザーへの通知
- モニタリング

---

## 🚀 次のアクション

### 即座に実行可能

1. **環境変数の確認**
   ```bash
   cat .env.local | grep GOOGLE_SHEETS
   ```
   実際のスプレッドシートのタイトルと対応しているか確認

2. **システム担当者への質問**
   `IMPROVEMENT_PLAN.md`の「確認が必要な事項」セクションを参照

3. **Phase 1の開始**
   新しいスプレッドシートの作成を開始

### 承認が必要

- [ ] この分析結果の確認
- [ ] 改善計画の承認
- [ ] Phase 1実施の承認
- [ ] 本番移行の承認

---

## 📞 サポート

### 質問がある場合

以下のドキュメントを参照してください：

1. **構造の詳細を知りたい** → `ANALYSIS.md`
2. **データの対応を知りたい** → `DATA_MAPPING.md`
3. **実装手順を知りたい** → `IMPROVEMENT_PLAN.md`
4. **セルの詳細を知りたい** → `TEMPLATE_STRUCTURE_REPORT.md`

### 関連ファイル

- `/workspaces/bonica-system/lib/google-sheets-client.ts` - 現在のGoogle Sheets連携コード
- `/workspaces/bonica-system/scripts/analyze-sheets-template.ts` - テンプレート分析スクリプト
- `/workspaces/bonica-system/scripts/generate-analysis-report.ts` - レポート生成スクリプト

---

## 📝 分析手法

このプロジェクトで使用した分析ツール：

1. **Google Sheets API**: 既存テンプレートの構造を自動取得
2. **TypeScript**: データ構造の解析とレポート生成
3. **JSONデータ**: PDFサンプルの構造化
4. **マニュアル比較**: 視覚的な差異の確認

---

## ✅ 分析完了チェックリスト

- [x] 既存テンプレートの構造分析
- [x] PDFサンプルデザインの詳細分析
- [x] データマッピング表の作成
- [x] 改善計画の策定
- [x] リスク評価
- [x] 実装手順の明確化
- [x] 成功基準の定義
- [x] 質問リストの作成

**Status**: ✅ **分析完了**

次のステップ: システム担当者との確認・承認待ち

---

**最終更新**: 2025年11月15日
**作成者**: Claude Code
**バージョン**: 1.0
