# データマッピング表

## 目的
PDFデザインの項目と既存Google Sheetsテンプレートの対応関係を明確化し、データ投入処理の実装に必要な情報を提供します。

---

## 明細テーブルのマッピング

### PDFデザイン → 既存テンプレート → 新テンプレート（推奨）

| PDF列順 | PDF項目名 | 既存テンプレート | 新テンプレート | データソース | 備考 |
|---------|-----------|-----------------|---------------|-------------|------|
| 1 | 日付 | **なし** | **A列** | API: `delivery_date` または `item.delivery_date` | MM/DD(曜日)形式 |
| 2 | 品名 | A列 | **B列** | API: `product_name` | 産地情報も含む |
| 3 | 単価 | C列 | **C列** | API: `unit_price` | 数値、円 |
| 4 | 数量 | B列 | **D列** | API: `quantity` | 数値、小数点2桁 |
| 5 | 単位 | **なし** | **E列** | API: `unit` | kg, 袋, 箱など |
| 6 | 税率 | **なし** | **F列** | API: `tax_rate` | 8% or 10% |
| 7 | 税抜金額 | D列（金額） | **G列** | **数式**: `=C*D` | 単価×数量 |
| 8 | 消費税 | **なし** | **H列** | **数式**: `=G*SUBSTITUTE(F,"%","")/100` | 税抜金額×税率 |
| 9 | 備考 | **なし** | **I列** | API: `remarks` または `notes` | 冷蔵、冷凍など |

### 列数の変化
- **既存**: 4列（A, B, C, D）
- **新規**: 9列（A, B, C, D, E, F, G, H, I）
- **追加列**: 5列（日付, 単位, 税率, 消費税, 備考）

---

## ヘッダー部分のマッピング

### タイトル行

| 項目 | PDFデザイン | 既存テンプレート | 新テンプレート | データソース |
|------|------------|-----------------|---------------|-------------|
| タイトル | 「請求書」 | B2 | **A1:I1（結合）** | 固定値: "請求書" |
| 背景色 | #00A0E9（青） | #FFFFFF（白） | **#00A0E9** | - |
| 文字色 | 白 | 黒 | **白** | - |
| セル結合 | あり | **なし** | **A1:I1** | - |

### 顧客情報ブロック（左側）

| 項目 | PDFデザイン | 既存テンプレート | 新テンプレート | データソース |
|------|------------|-----------------|---------------|-------------|
| 顧客名 | 表示 | A5 → B5 | **A3** | API: `customer_name` + " 御中" |
| 顧客名（値） | - | B5（推定） | **B3:D3（結合）** | - |
| 住所（ラベル） | - | A6 | **削除** | - |
| 住所（値） | - | B6（推定） | **削除** | PDFには表示されていない |

### 請求情報ブロック（右上）

| 項目 | PDFデザイン | 既存テンプレート | 新テンプレート | データソース |
|------|------------|-----------------|---------------|-------------|
| 請求番号 | 「請求No.S000000330」 | A3 → B3 | **G2** | API: `invoice_number` |
| 請求年月 | 「2025/09」 | A4 → B4 | **G3** | API: `invoice_date`（YYYY/MM形式） |

### 会社情報ブロック（右上）

| 項目 | PDFデザイン | 既存テンプレート | 新テンプレート | データソース |
|------|------------|-----------------|---------------|-------------|
| 法人番号 | T9030001039654 | **なし** | **H2** | 固定値 or 環境変数 |
| 会社名 | 株式会社 ボニカ・アグリジェント | B1 | **H3** | 固定値 |
| 郵便番号 | 〒341-0035 | **なし** | **H4** | 固定値 |
| 住所 | 埼玉県三郷市鷹野4-441 | **なし** | **H5** | 固定値 |
| TEL | 048-954-6891 | **なし** | **H6** | 固定値 |
| FAX | 048-954-6892 | **なし** | **H7** | 固定値 |

### 請求金額表示（目立つ表示）

| 項目 | PDFデザイン | 既存テンプレート | 新テンプレート | データソース |
|------|------------|-----------------|---------------|-------------|
| ラベル | 「今回ご請求額」 | **なし** | **A5** | 固定値 |
| 金額 | 62,416円 | C22 → D22 | **B5:D5（結合）** | **数式**: 税抜合計+税額合計 |
| フォントサイズ | 大きい | 通常 | **18pt以上** | - |

---

## 明細テーブルのヘッダー行

### ヘッダー行（10行目 → 新: 11行目）

| 項目 | 既存セル | 既存項目名 | 新セル | 新項目名 | 背景色 |
|------|----------|-----------|--------|---------|--------|
| 1列目 | - | - | **A11** | **日付** | #00A0E9 or #808080 |
| 2列目 | A10 | 商品名 | **B11** | **品名** | 同上 |
| 3列目 | C10 | 単価 | **C11** | **単価** | 同上 |
| 4列目 | B10 | 数量 | **D11** | **数量** | 同上 |
| 5列目 | - | - | **E11** | **単位** | 同上 |
| 6列目 | - | - | **F11** | **税率** | 同上 |
| 7列目 | D10 | 金額 | **G11** | **税抜金額** | 同上 |
| 8列目 | - | - | **H11** | **消費税** | 同上 |
| 9列目 | - | - | **I11** | **備考** | 同上 |

#### 既存からの変更点
1. **ヘッダー行位置**: 10行目 → 11行目（請求金額表示を挿入するため）
2. **背景色**: #ffe4b5（薄いオレンジ） → #00A0E9または#808080（濃いグレー）
3. **文字色**: 黒 → 白
4. **配置**: 中央揃え（既存も同じ）

---

## フッター部分のマッピング

### 振込先情報ブロック（左下）

**既存テンプレート**: なし
**新テンプレート**: 追加が必要

| 項目 | 新セル | 値 | データソース |
|------|--------|-----|-------------|
| タイトル | A60 | 「お振込先」 | 固定値 |
| 金融機関名 | A61 | 朝日信用金庫 | 固定値 or DB |
| 支店名 | A62 | 三郷支店 | 固定値 or DB |
| 口座種別 | A63 | 普通 | 固定値 or DB |
| 口座番号 | A64 | 0430910 | 固定値 or DB |
| 口座名義 | A65 | カ)ボニカ・アグリジェント | 固定値 or DB |

**推定位置**: 明細の最終行 + 5行程度のオフセット

### 税額集計ブロック（右下）

**既存テンプレート**: なし
**新テンプレート**: 追加が必要

| 項目 | 新セル（ラベル） | 新セル（値） | 数式 |
|------|-----------------|-------------|------|
| 10%対象額 | F60 | G60 | `=SUMIF(F12:F59,"10%",G12:G59)` |
| 10%消費税額 | F61 | G61 | `=SUMIF(F12:F59,"10%",H12:H59)` |
| 8%対象額 | F62 | G62 | `=SUMIF(F12:F59,"8%",G12:G59)` |
| 8%消費税額 | F63 | G63 | `=SUMIF(F12:F59,"8%",H12:H59)` |
| 合計金額 | F64 | G64 | `=SUM(G12:G59)+SUM(H12:H59)` |
| 合計税額 | F65 | G65 | `=SUM(H12:H59)` |

**推定位置**: 振込先情報ブロックと同じ高さ（60-65行目）

---

## 数式の完全なリスト

### 明細行の数式（12行目〜最大60行目まで）

#### G列（税抜金額）
```excel
=IF(AND(C12<>"", D12<>""), C12*D12, "")
```
- C列（単価）とD列（数量）の両方に値がある場合のみ計算

#### H列（消費税）
```excel
=IF(AND(G12<>"", F12<>""), G12*VALUE(SUBSTITUTE(F12,"%",""))/100, "")
```
- G列（税抜金額）とF列（税率）の両方に値がある場合のみ計算
- `SUBSTITUTE`で「8%」→「8」に変換
- `VALUE`で数値化

### フッター集計の数式

#### 10%対象額（G60）
```excel
=SUMIF(F$12:F$59,"10%",G$12:G$59)
```

#### 10%消費税額（G61）
```excel
=SUMIF(F$12:F$59,"10%",H$12:H$59)
```

#### 8%対象額（G62）
```excel
=SUMIF(F$12:F$59,"8%",G$12:G$59)
```

#### 8%消費税額（G63）
```excel
=SUMIF(F$12:F$59,"8%",H$12:H$59)
```

#### 合計金額（G64）
```excel
=SUM(G$12:G$59)+SUM(H$12:H$59)
```

#### 合計税額（G65）
```excel
=SUM(H$12:H$59)
```

#### 請求金額表示（B5）
```excel
=G64
```
- フッターの合計金額と連動

---

## セルアドレスの完全なマッピング

### 新テンプレートのセル配置（推奨）

```
     A          B          C        D        E       F        G          H         I
1  [請求書（A1:I1結合、背景#00A0E9、文字白）                                           ]
2   (空)       (空)       (空)     (空)     (空)    (空)    請求No.    T9030...    (空)
3   顧客名:    [ムスビガーデン（B3:D3結合）      ]         (空)    2025/09    会社名      (空)
4   (空)       (空)       (空)     (空)     (空)    (空)    (空)       郵便番号    (空)
5  今回ご請求額 [62,416円（B5:D5結合）            ]         (空)    (空)       住所        (空)
6   (空)       (空)       (空)     (空)     (空)    (空)    (空)       TEL         (空)
7   (空)       (空)       (空)     (空)     (空)    (空)    (空)       FAX         (空)
8   (空行)
9   (空行)
10  (空行)
11  日付       品名       単価     数量     単位    税率    税抜金額    消費税      備考
12  08/22(金)  広石農園... 350      5.00     kg      8%      =C12*D12   =G12*... (空)
13  08/22(金)  岡永農園... 1600     0.80     kg      8%      =C13*D13   =G13*... (空)
...
60  お振込先   (空)       (空)     (空)     (空)    10%対象  =SUMIF...  (空)     (空)
61  朝日信用...  (空)      (空)     (空)     (空)    10%税額  =SUMIF...  (空)     (空)
62  三郷支店   (空)       (空)     (空)     (空)    8%対象   =SUMIF...  (空)     (空)
63  普通       (空)       (空)     (空)     (空)    8%税額   =SUMIF...  (空)     (空)
64  0430910    (空)       (空)     (空)     (空)    合計金額 =SUM...    (空)     (空)
65  カ)ボニ... (空)       (空)     (空)     (空)    合計税額 =SUM...    (空)     (空)
```

---

## APIデータ構造との対応

### 現在のDeliveryDataインターフェース（推定）

```typescript
interface DeliveryData {
  delivery_number: string;        // → G2（請求書番号）
  delivery_date: string;          // → G3（請求年月）、A12〜（各行の日付）
  customer_name: string;          // → B3（顧客名）
  total_amount: number;           // → B5（今回ご請求額）
  items: {
    product_name: string;         // → B列（品名）
    quantity: number;             // → D列（数量）
    unit_price: number;           // → C列（単価）
    unit?: string;                // → E列（単位）★新規
    tax_rate: number;             // → F列（税率）★新規
    delivery_date?: string;       // → A列（日付）★新規
    remarks?: string;             // → I列（備考）★新規
  }[];
  subtotal_8: number;             // → G62（8%対象額）★新規
  tax_8: number;                  // → G63（8%消費税額）★新規
  subtotal_10: number;            // → G60（10%対象額）★新規
  tax_10: number;                 // → G61（10%消費税額）★新規
  total_tax: number;              // → G65（合計税額）★新規
}
```

### 追加が必要なフィールド（★マーク）
1. `items[].unit`（単位）
2. `items[].tax_rate`（税率）
3. `items[].delivery_date`（配送日）
4. `items[].remarks`（備考）
5. `subtotal_8`（8%対象額）
6. `tax_8`（8%消費税額）
7. `subtotal_10`（10%対象額）
8. `tax_10`（10%消費税額）
9. `total_tax`（合計税額）

---

## 列幅の推奨値

PDFのビジュアルデザインから推測される列幅：

| 列 | 項目 | ピクセル幅（推定） | パーセント |
|----|------|-------------------|-----------|
| A | 日付 | 80px | 8% |
| B | 品名 | 250px | 25% |
| C | 単価 | 80px | 8% |
| D | 数量 | 60px | 6% |
| E | 単位 | 50px | 5% |
| F | 税率 | 50px | 5% |
| G | 税抜金額 | 100px | 10% |
| H | 消費税 | 80px | 8% |
| I | 備考 | 250px | 25% |

**合計**: 約1000px（A4用紙幅）

---

## 罫線の設定

### ヘッダー行（11行目）
- **上罫線**: 太線（2pt）
- **下罫線**: 太線（2pt）
- **左右罫線**: 細線（1pt）

### データ行（12〜59行目）
- **全罫線**: 細線（1pt）

### フッター集計行（60〜65行目）
- **上罫線**: 太線（2pt、60行目のみ）
- **下罫線**: 太線（2pt、65行目のみ）
- **左右罫線**: 細線（1pt）

---

## 印刷設定の推奨

- **用紙サイズ**: A4
- **印刷方向**: 縦
- **余白**: 上下左右 1.5cm
- **拡大縮小**: 100%（自動調整なし）
- **ページ区切り**: 60行目の下（必要に応じて）
- **ヘッダー/フッター**: なし（テンプレート内に含まれるため）

---

## 次のステップ

このマッピング表を基に、以下の作業を進めます：

1. ✅ **新テンプレートの作成**（Phase 1）
2. ✅ **APIデータ構造の更新**（lib/google-sheets-client.tsの修正）
3. ✅ **データ投入ロジックの実装**
4. ✅ **数式の組み込み**
5. ✅ **テスト・検証**

詳細は`IMPROVEMENT_PLAN.md`を参照してください。
