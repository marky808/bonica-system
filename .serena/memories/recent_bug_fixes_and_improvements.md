# 最近のバグ修正と改善履歴

## 2025-11-14: 商品プレフィックス機能追加とバグ修正

### 修正1: カテゴリー削除のバグ修正
**問題**: 
- カテゴリー削除時に「削除しました」と表示されるが実際には削除されていない
- 使用中のカテゴリーでもエラーメッセージが表示されない

**原因**:
- APIレスポンスの`error`プロパティをチェックしていなかった
- レスポンスに`error`があっても成功として処理していた

**修正内容** (`components/masters/category-management.tsx`):
```typescript
const response = await apiClient.deleteCategory(id)

// レスポンスのエラーチェックを追加
if (response.error) {
  throw new Error(response.error)
}
```

**修正箇所**: line 93-95

### 修正2: プレフィックス削除の同様のバグ修正
**修正内容** (`components/masters/product-prefix-management.tsx`):
同様のエラーチェックを追加（line 93-95）

### 修正3: ナビゲーションメニュー表示の問題
**問題**: 
- 「商品プレフィックス」がマスタ管理に表示されない

**原因**:
- コードには追加されているが、ブラウザキャッシュの問題
- マスタ管理メニューが折りたたまれている

**解決方法**:
- マスタ管理をクリックして展開
- ブラウザのハードリロード（Ctrl+Shift+R）

## 過去の主要な修正（参考）

### 2025-11-13: 税率列追加と税率別集計の配置変更
**変更内容**:
- 納品書に税率列（8%/10%）を追加
- 税率別集計を商品明細の右から下に移動
- `lib/google-sheets-client.ts`: line 576-647

### 2025-11-12: カテゴリー削除エラーメッセージ改善
**変更内容**:
- 削除確認時に使用中の警告を追加
- エラーメッセージを詳細化
- `components/masters/category-management.tsx`: line 83-105

### 2025-11-11: 納品書URLのクリック可能化
**変更内容**:
- 納品書作成成功時のURLをクリック可能なリンクに変更
- 別ウィンドウで開く
- `app/deliveries/page.tsx`: line 381-410

### 2025-11-10: 0円仕入れ対応
**変更内容**:
- 自家製造品の0円仕入れを可能に
- バリデーションを`!unitPrice`から`unitPrice === undefined || unitPrice === null`に変更
- `app/api/purchases/route.ts`: line 110
- `app/api/purchases/[id]/route.ts`: line 113-114

## 削除機能の仕様

### カテゴリー削除
- 仕入れデータで使用中の場合は削除不可
- エラーメッセージ: 「このカテゴリーは仕入れデータで使用されているため削除できません」
- 対処方法: 関連する仕入れデータを削除または別のカテゴリーに変更

### プレフィックス削除
- 仕入れデータで使用中の場合は削除不可
- エラーメッセージ: 「このプレフィックスは使用されているため削除できません」
- 対処方法: 関連する仕入れデータを削除または別のプレフィックスに変更

## デバッグ時の確認ポイント

### ブラウザコンソールの確認方法
1. F12キーでデベロッパーツールを開く
2. Consoleタブを確認
3. エラーメッセージやログを確認

### ネットワークリクエストの確認
1. F12 → Networkタブ
2. 操作を実行
3. APIリクエストとレスポンスを確認
4. Statusが200以外の場合はエラー

### よくある問題と解決方法
1. **変更が反映されない**: ブラウザキャッシュをクリア、ハードリロード
2. **削除できない**: 使用中データがないか確認
3. **表示がおかしい**: ページ全体をリロード
4. **データが更新されない**: APIレスポンスのエラーを確認
